# IMX296 Camera Viewer and Capture

Проект для работы с камерой IMX296 на Raspberry Pi. Предоставляет инструменты для просмотра видео в реальном времени и автоматического сохранения изображений с настраиваемыми параметрами экспозиции и усиления.

## Описание

Проект предназначен для работы с камерой IMX296 на Raspberry Pi Compute Module 4/5. Основной функционал включает:
- Просмотр видео с камеры в реальном времени через OpenCV
- Автоматическое сохранение каждого кадра с временными метками
- Настройка параметров экспозиции и усиления через переменные окружения или файл `.env`
- Поддержка режима триггера камеры

## Требования

### Аппаратное обеспечение
- Raspberry Pi Compute Module 4 или Compute Module 5
- Камера IMX296
- Дисплей для просмотра видео (опционально)

### Программное обеспечение
- Raspberry Pi OS (64-bit)
- Python 3.x
- Зависимости Python:
  - `picamera2` - библиотека для работы с камерой
  - `opencv-python` (cv2) - обработка и отображение изображений
  - `python-dotenv` - загрузка переменных окружения из файла (опционально)

## Установка

### 1. Настройка системы Raspberry Pi

Скопируйте файл `config.txt` в `/boot/firmware/config.txt` на вашей Raspberry Pi. Ключевые настройки:
```
dtoverlay=imx296
cma=128M
arm_64bit=1
```

Для CM4:
```
[cm4]
otg_mode=1
```

Для CM5:
```
[cm5]
dtoverlay=dwc2,dr_mode=host
dtoverlay=imx296
```

### 2. Установка зависимостей Python

```bash
pip install picamera2 opencv-python python-dotenv
```

### 3. Настройка переменных окружения

Создайте файл `.env` в корне проекта (опционально):
```
GAIN=64
EXPOSURE_TIME=50000
```


**Важно:** Если переменные окружения не установлены, скрипт завершится с ошибкой.

## Структура проекта

### Основные скрипты

- **s296.py** - Основной скрипт для просмотра видео и сохранения кадров
  - Загружает настройки из переменных окружения или `.env` файла
  - Отображает видео в реальном времени через OpenCV
  - Автоматически сохраняет каждый кадр в папку `images/`
  - Формат имени файла: `MM-DD_HH-MM-SS.png` (UTC время)
  - Выход: нажмите 'q' или Ctrl+C

## Подробное описание s296.py

### Назначение

Скрипт `s296.py` является основным модулем проекта для работы с камерой IMX296. Он обеспечивает непрерывный захват кадров с камеры, их отображение в реальном времени и автоматическое сохранение каждого кадра на диск.

### Структура кода

#### Импорты и зависимости

```python
import cv2                    # OpenCV для обработки и отображения изображений
from picamera2 import Picamera2  # Библиотека для работы с камерой Raspberry Pi
import time                   # Работа со временем для генерации имен файлов
from os import environ        # Доступ к переменным окружения
import os                     # Работа с файловой системой
from pathlib import Path      # Работа с путями к файлам
```

Скрипт также поддерживает опциональную загрузку переменных окружения из файла `.env` через библиотеку `python-dotenv`.

#### Функция `live_camera_view()`

Основная функция скрипта, выполняющая весь цикл работы с камерой.

**Инициализация камеры:**

1. **Загрузка параметров:**
   - Читает переменные окружения `GAIN` и `EXPOSURE_TIME`
   - Если установлен `python-dotenv`, пытается загрузить их из файла `.env` в корне проекта
   - Преобразует `GAIN` в `float` и `EXPOSURE_TIME` в `int`
   - Выводит текущие значения параметров в консоль

2. **Конфигурация камеры:**
   - Создает объект `Picamera2`
   - Сначала создается video configuration (строка 23)
   - Затем создается still configuration с параметрами управления (строка 25):
     - `ExposureTime` - время экспозиции из переменной окружения
     - `AnalogueGain` - аналоговое усиление из переменной окружения
     - `FrameRate` - фиксированная частота 40 fps
   - Применяет конфигурацию к камере

3. **Запуск камеры:**
   - Вызывает `picam2.start()` для инициализации захвата

**Основной цикл захвата:**

```python
while True:
    frame = picam2.capture_array()  # Захват кадра в формате RGB (numpy array)
    frame_bgr = cv2.cvtColor(frame, cv2.COLOR_RGB2BGR)  # Конвертация для OpenCV
    cv2.imshow('Live Camera Feed', frame_bgr)  # Отображение кадра
    # Сохранение кадра с временной меткой
    # Проверка нажатия клавиши 'q' для выхода
```

**Обработка кадров:**

1. **Захват:** `picam2.capture_array()` возвращает кадр в формате RGB как numpy array
2. **Конвертация:** Преобразование RGB → BGR для корректного отображения в OpenCV
3. **Отображение:** Показ кадра в окне "Live Camera Feed"
4. **Сохранение:**
   - Генерация имени файла на основе UTC времени: `MM-DD_HH-MM-SS.png`
   - Автоматическое создание папки `images/` при первом запуске
   - Сохранение в оригинальном RGB формате (без конвертации в BGR)

**Обработка ошибок:**

- `KeyboardInterrupt` (Ctrl+C): Корректное завершение с сообщением
- `finally`: Гарантированное освобождение ресурсов:
  - Остановка камеры (`picam2.stop()`)
  - Закрытие всех окон OpenCV (`cv2.destroyAllWindows()`)

**Выход из программы:**

- Нажатие клавиши 'q' в окне OpenCV
- Комбинация Ctrl+C в терминале

### Алгоритм работы

1. **Инициализация:**
   ```
   Загрузка .env → Чтение GAIN и EXPOSURE_TIME → Создание объекта камеры
   ```

2. **Настройка:**
   ```
   Создание конфигурации → Установка параметров → Запуск камеры
   ```

3. **Цикл захвата:**
   ```
   Захват кадра → Конвертация RGB→BGR → Отображение → Сохранение → Проверка выхода
   ```

4. **Завершение:**
   ```
   Остановка камеры → Закрытие окон → Освобождение ресурсов
   ```

### Особенности реализации

- **Использование still configuration для видео:** Скрипт использует `create_still_configuration()` вместо `create_video_configuration()` для захвата кадров. Это позволяет применять настройки экспозиции и усиления из режима фотографии при непрерывном захвате.

- **UTC время:** Используется `time.gmtime()` вместо локального времени, что обеспечивает единообразие имен файлов независимо от часового пояса.

- **Автоматическое создание директорий:** Папка `images/` создается автоматически при первом сохранении, если она не существует.

- **Обработка отсутствия dotenv:** Скрипт продолжает работу даже если библиотека `python-dotenv` не установлена, полагаясь только на системные переменные окружения.

### Требования к переменным окружения

- **GAIN** (обязательно): Аналоговое усиление камеры (от 1 до 64)
- **EXPOSURE_TIME** (обязательно): Время экспозиции в микросекундах (например, 50000)

Если переменные не установлены, скрипт завершится с ошибкой при попытке преобразования `None` в число.

### Производительность

- Частота захвата: до 40 fps (ограничено параметром `FrameRate`)
- Формат сохранения: PNG (без сжатия, высокое качество)
- Использование памяти: зависит от разрешения камеры и размера буферов

### Примеры использования

**Базовый запуск:**
```bash
export GAIN=64
export EXPOSURE_TIME=50000
python s296.py
```

**С использованием .env файла:**
```bash
# Создать .env файл с параметрами
python s296.py
```

**Через скрипт запуска:**
```bash
./run.sh
```

### Конфигурационные файлы

- **config.txt** - Конфигурация Raspberry Pi для работы с камерой IMX296
  - Включает overlay для камеры IMX296
  - Настройки CMA памяти (128M)
  - Конфигурация для CM4 и CM5
  - Включен DRM VC4 V3D драйвер для графики

- **cmdline.txt** - Параметры командной строки ядра Linux
  - Настройки консоли и загрузки системы
  - Регион Wi-Fi: RU

- **run.sh** - Скрипт запуска основного приложения
  ```bash
  python s296.py 
  ```
  Принимает до 3 аргументов командной строки

- **trigger_on.sh** - Скрипт для включения режима триггера камеры
  ```bash
  echo 1 | sudo tee /sys/module/imx296/parameters/trigger_mode
  ```
  Требует прав суперпользователя

## Использование

### Основной режим работы

```bash
python s296.py
```

Или через скрипт запуска:
```bash
chmod +x run.sh
./run.sh
```

### Настройка параметров камеры

Параметры настраиваются через переменные окружения:

- **GAIN** - Аналоговое усиление (целое,  1 до  64)
- **EXPOSURE_TIME** - Время экспозиции в микросекундах (int, например: 50000)
- **FrameRate** - Частота кадров (жестко задана: 40 fps)

Пример настройки: файл .env
GAIN=64
EXPOSURE_TIME=50000
```

### Режим триггера

Для включения режима триггера камеры:
```bash
chmod +x trigger_on.sh
sudo ./trigger_on.sh
```

## Сохранение изображений

Все изображения автоматически сохраняются в папку `images/` (создается автоматически при первом запуске).

Формат имени файла: `MM-DD_HH-MM-SS.png`

Пример: `11-19_14-30-45.png`

**Примечание:** Используется UTC время (`time.gmtime()`), а не локальное время.

## Управление

- **'q'** - Выход из программы (только в s296.py)
- **Ctrl+C** - Аварийное завершение (работает в обоих скриптах)

## Технические детали


### Формат изображений

- Захват: RGB формат через `capture_array()`
- Отображение: конвертация в BGR для OpenCV
- Сохранение: RGB формат (оригинальный формат камеры)

## Устранение неполадок

### Ошибка "GAIN" или "EXPOSURE_TIME" не найдены
Убедитесь, что переменные окружения установлены или создан файл `.env`

### Камера не определяется
Проверьте:
- Правильность подключения камеры
- Наличие `dtoverlay=imx296` в `/boot/firmware/config.txt`
- Перезагрузку системы после изменения config.txt

### Низкая производительность
- Убедитесь, что CMA память достаточна (128M в config.txt)
- Проверьте использование CPU: `top` или `htop`

### Изображения не сохраняются
- Проверьте права доступа к папке проекта
- Убедитесь, что достаточно места на диске

## Примечания

- Проект оптимизирован для Raspberry Pi CM4/CM5
- Требуется 64-bit версия Raspberry Pi OS
- Для работы с камерой требуется достаточное количество CMA памяти (рекомендуется 128M)
- Время в именах файлов - UTC, не локальное время

## Лицензия

Не указана. Используйте на свой риск.
